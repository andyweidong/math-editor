<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学公式编辑器 (原生Word导出版)</title>
    <style>
        :root {
            --border-color: #d1d5db;
            --background-color: #f9fafb;
            --button-bg: #2563eb;
            --button-hover-bg: #1d4ed8;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--background-color);
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            z-index: 10;
        }
        header h1 {
            margin: 0;
            font-size: 1.5em;
            color: #111827;
        }
        #download-btn {
            padding: 10px 20px;
            font-size: 1em;
            color: white;
            background-color: var(--button-bg);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #download-btn:hover:not(:disabled) {
            background-color: var(--button-hover-bg);
        }
        #download-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        #app-container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }
        .panel {
            flex: 1;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            padding: 10px 15px;
            background-color: #f3f4f6;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: #374151;
        }
        #source-wrapper, #preview {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        #source {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            outline: none;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 16px;
            line-height: 1.6;
            background-color: transparent;
        }
        #preview {
            font-size: 16px;
            line-height: 1.6;
            word-wrap: break-word;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

    <header>
        <h1>数学公式编辑器 (原生Word导出版)</h1>
        <button id="download-btn">下载为Word文档</button>
    </header>

    <div id="app-container">
        <div class="panel">
            <div class="panel-header">原文输入 (Markdown + LaTeX)</div>
            <div id="source-wrapper">
                <textarea id="source">以下是涵盖数学、物理、化学、统计学、工程等多个领域的核心公式精选（因学体系庞大，无法穷尽所有公式，仅选取最具代表性的基础公式和核心公式）：

### 一、数学公式
数学公式是数学学科中用于表达数量关系、逻辑关系和运算规则的符号组合，涵了代数、几何、微积分、概率论等多个分支。以下为你介绍一些常见且重要的数公式：

#### 1、代数与基础运算
- 完全平方公式：
    - \((a + b)^2 = a^2 + 2ab + b^2\)
    - \((a - b)^2 = a^2 - 2ab + b^2\)
- 平方差公式：  
    \((a + b)(a - b) = a^2 - b^2\)
- 一元二次方程求根公式：  
    对于方程 \(ax^2 + bx + c = 0\)（\(a \neq 0\)），根为：  
    \(x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}\)  
    其中，判别式 \(\Delta = b^2 - 4ac\)：  
    - \(\Delta > 0\) 时，有两个不相等的实根；  
    - \(\Delta = 0\) 时，有两个相等的实根；  
    - \(\Delta < 0\) 时，无实根（有共轭复根）。

#### 2、几何公式
- 三角形面积：  
    - 基本公式：\(S = \frac{1}{2} \times 底 \times 高\)  
    - 海伦公式（已知三边 \(a, b, c\)）：  
      设半周长 \(p = \frac{a + b + c}{2}\)，则 \(S = \sqrt{p(p - a)(p - b)(p - c)}\)
- 圆的公式：  
    - 周长：\(C = 2\pi r\)（\(r\) 为半径）  
    - 面积：\(S = \pi r^2\)
- 勾股定理（直角三角形中，直角边 \(a, b\)，斜边 \(c\)）：  
    \(a^2 + b^2 = c^2\)

#### 3、微积分基础
- 导数定义：  
    函数 \(f(x)\) 在 \(x_0\) 处的导数：  
    \(f'(x_0) = \lim_{\Delta x \to 0} \frac{f(x_0 + \Delta x) - f(x_0)}{\Delta x}\)
- 基本求导公式：  
    - \((x^n)' = nx^{n-1}\)  
    - \((\sin x)' = \cos x\)  
    - \((\cos x)' = -\sin x\)  
    - \((e^x)' = e^x\)  
    - \((\ln x)' = \frac{1}{x}\)
- 定积分（区间 \([a, b]\) 上的积分）：  
    \(\int_{a}^{b} f(x) dx = F(b) - F(a)\)，其中 \(F(x)\) 是 \(f(x)\) 的原函数（即 \(F'(x) = f(x)\)）

#### 4、概率论基础
- 概率的加法公式：  
    对于两个事件 \(A, B\)：  
    \(P(A \cup B) = P(A) + P(B) - P(A \cap B)\)  
    若 \(A, B\) 互斥（\(A \cap B = \emptyset\)），则 \(P(A \cup B) = P(A) + P(B)\)
- 条件概率公式：  
    \(P(B|A) = \frac{P(A \cap B)}{P(A)}\)（\(P(A) > 0\)）

#### 5. 线性代数
- 矩阵乘法：设 \(A = (a_{ij})_{m \times n}\)，\(B = (b_{jk}){n \times p}\)，则 \(AB = (c_{ik})_{m \times p}\)，其中 \(c{ik} = \sum_{j=1}^n a_{ij}b_{jk}\)
- 行列式（二阶）：\(\begin{vmatrix} a & b \\ c & d \end{vmatrix} = ad - bc\)
- 特征值与特征向量：若 \(Ax = \lambda x\)（\(x \neq 0\)），则 \(\lambda\) 是矩阵 \(A\) 的特征值，\(x\) 是对应特征向量

#### 6. 复变函数
- 欧拉公式：\(e^{i\theta} = \cos\theta + i\sin\theta\)（\(i\)为虚数单位，\(i^2 = -1\)）
- 复数模长：对于 \(z = a + bi\)，\(|z| = \sqrt{a^2 + b^2}\)

#### 7. 微分方程
- 一阶线性微分方程通解：\(y' + P(x)y = Q(x)\) 的解为  
  \(y = e^{-\int P(x)dx} \left( \int Q(x)e^{\int P(x)dx}dx + C \right)\)（\(C\) 为常数）


### 二、物理公式
#### 1. 经典力学
- 牛顿第二定律：\(F = ma\)（\(F\) 为合力，\(m\) 为质量，\(a\) 为速度）
- 动量定理：\(\Delta p = F_{\text{合}} \Delta t\)（动量变化等合外力的冲量）
- 动能定理：\(W_{\text{合}} = \Delta E_k = \frac{1}{2}mv_2^2- \frac{1}{2}mv_1^2\)（合外力做功等于动能变化）
- 万有引力定律：\(F = G\frac{m_1m_2}{r^2}\)（\(G\) 为引力常量，\(r\) 为两物体间距）

#### 2. 电磁学
- 库仑定律：\(F = k\frac{q_1q_2}{r^2}\)（\(k\) 为静电力常量，\(q\) 为电荷量）
- 欧姆定律：\(I = \frac{U}{R}\)（电流 \(I\)，电压 \(U\)，电阻 \(R\)）
- 焦耳定律：\(Q = I^2Rt\)（电流热效应，\(t\) 为时间）
- 法拉第电磁感应定律：\(\mathcal{E} = n\left| \frac{\Delta\Phi}{\Delta t} \right|\)（感应电动势，\(n\) 为匝数，\(\Phi\) 磁通量）

#### 3. 热学
- 理想气体状态方程：\(PV = nRT\)（\(P\) 压强，\(V\) 体积，\(n\)物质的量，\(R\) 气体常量，\(T\) 热力学温度）
- 热力学第一定律：\(\Delta U = Q + W\)（内能变化 = 吸收的热量 + 界对系统做的功）

#### 4. 光学与近代物理
- 光速公式：\(c = \lambda \nu\)（\(c\) 真空中光速，\(\lambda\)波长，\(\nu\) 频率）
- 爱因斯坦质能方程：\(E = mc^2\)（能量 \(E\)，质量 \(m\)）
- 光电效应方程：\(E_{\text{km}} = h\nu - W_0\)（光电子最大动能 =光子能量 - 逸出功）


### 三、化学公式
#### 1. 基础化学
- 物质的量公式：\(n = \frac{m}{M} = \frac{N}{N_A}\)（\(m\) 量，\(M\) 摩尔质量，\(N\) 粒子数，\(N_A\) 阿伏伽德罗常数）
- 溶液浓度：物质的量浓度 \(c = \frac{n}{V}\)（\(V\) 溶液体积）

#### 2. 化学热力学
- 化学反应速率：\(v = \frac{1}{v_B} \cdot \frac{\Delta c_B}{\Delta t}\)（\(v_B\) 化学计量数，\(c_B\) 物质浓度）
- 化学平衡常数（溶液反应）：对于反应 \(aA + bB\rightleftharpoons cC + dD\)，  
  \(K_c = \frac{[C]^c[D]^d}{[A]^a[B]^b}\)（\([\cdot]\) 为平衡浓度）

#### 3. 酸碱与氧化还原
- 水的离子积：\(K_w = [H^+][OH^-] = 10^{-14}\)（25℃时）
- 电极电势与吉布斯自由能：\(\Delta G = -nFE_{\text{池}}\)（\(n\) 电子转移数，\(F\) 法拉第常数，\(E_{\text{池}}\) 电池电动势）

#### 4. 有机化学（典型反应式）
- 甲烷燃烧：\(\text{CH}_4 + 2\text{O}_2 \xrightarrow{\text{燃}} \text{CO}_2 + 2\text{H}_2\text{O}\)
- 乙烯加成：\(\text{CH}_2=\text{CH}_2 + \text{Br}_2\rightarrow \text{CH}_2\text{BrCH}_2\text{Br}\)


### 四、统计学与概率论（续）
- 正态分布概率密度函数：\(f(x) = \frac{1}{\sqrt{2\pi}\sigma} e^{-\frac{(x - \mu)^2}{2\sigma^2}}\)（\(\mu\) 均值，\(\sigma\)标准差）
- 样本均值：\(\bar{x} = \frac{1}{n} \sum_{i=1}^n x_i\)
- 方差：\(\sigma^2 = \frac{1}{n} \sum_{i=1}^n (x_i - \mu)^2\)（总体方差）；样本方差 \(s^2 = \frac{1}{n-1} \sum_{i=1}^n (x_i- \bar{x})^2\)


### 五、工程与应用科学
- 胡克定律（弹性力学）：\(F = kx\)（弹簧弹力，\(k\) 劲度系数，\(x\) 形变量）
- 傅里叶变换（信号处理）：\(F(\omega) = \int_{-\infty}^{\infty}f(t)e^{-i\omega t}dt\)
- 香浓定理（信息论）：\(C = B\log_2(1 + \frac{S}{N})\)（信道容量\(C\)，带宽 \(B\)，信噪比 \(\frac{S}{N}\)）


以上公式覆盖了基础学科的核心内容。
</textarea>
            </div>
        </div>
        <div class="panel">
            <div class="panel-header">实时预览</div>
            <div id="preview"></div>
        </div>
    </div>

    <script>
        const sourceTextarea = document.getElementById('source');
        const previewDiv = document.getElementById('preview');
        const downloadBtn = document.getElementById('download-btn');

        /**
         * 【全新升级】智能预处理器：自动为裸露的、复杂的数学公式块包裹 '$' 定界符
         * @param {string} text - 原始的Markdown文本
         * @returns {string} - 经过预处理，包裹好裸露公式的文本
         */
         function preprocessAndWrapMath(text) {
            // 1. 定义保护区：我们不应在这些区域内进行任何自动包裹操作。
            // 包括：代码块(```, `), 已有的MathJax公式($, $$, \(), \[\]), HTML标签。
            const protectedBlocksRegex = /(```[\s\S]*?```|`[^`]*?`|\$\$[\s\S]*?\$\$|\\\[[\s\S]*?\\\]|\\\([\s\S]*?\\\)|<[^>]+>|(?:\$[^\$\n\r]+\$))/g;

            // 2. 分割文本：将文本分为“安全区（可处理）”和“保护区”
            const parts = text.split(protectedBlocksRegex);

            // 3. 定义一个“数学原子”的构成元素。
            // 这是一个更强大的正则表达式，能识别构成公式的各种小单元。
            const mathAtom = [
                '\\\\(?:[a-zA-Z]+|\\S)', // 匹配LaTeX命令 e.g., \sin, \alpha, \frac, \
                '[a-zA-Z0-9\\^_]+(?:\\{[^}]*\\})?', // 匹配变量、数字、上下标 e.g., a^2, x_1, \cos^2\alpha
                '[-+*/=<>|().,]', // 匹配常用操作符和括号
                '\\{[^}]*\\}' // 匹配独立的 {...} 块
            ].join('|');

            // 4. 定义一个“公式块”：由一个或多个“数学原子”及其中间的空格组成。
            const nakedFormulaRegex = new RegExp(`((?:(?:${mathAtom})\\s*)+)`, 'g');

            // 5. 遍历并处理所有“安全区”
            for (let i = 0; i < parts.length; i += 2) {
                // parts数组中，偶数索引是“安全区”，奇数索引是“保护区”
                if (parts[i]) {
                    // 对安全区应用我们的“公式块”识别引擎
                    parts[i] = parts[i].replace(nakedFormulaRegex, (match) => {
                        // 智能判断：只有当匹配到的块包含强数学特征时，才包裹它。
                        // 这可以防止错误地包裹普通文本，如 "(a > 0, b > 0)"
                        if (/[\\^_]/.test(match)) {
                             // 对于复杂的裸露公式，我们默认用行内 $...$ 包裹，
                             // 这样可以很好地处理 "正弦定理：公式" 这种混合行。
                            return `$${match.trim()}$`;
                        }
                        // 如果不含强特征，则保持原样
                        return match;
                    });
                }
            }
            
            // 6. 合并所有部分，返回最终文本
            return parts.join('');
        }

        // 更新预览区域并触发MathJax渲染
        const updatePreview = async () => {
            // 阶段一：智能预处理，自动包裹裸露的公式
            let sourceText = preprocessAndWrapMath(sourceTextarea.value);

            // 阶段二：健壮隔离、解析、还原（代码与之前版本完全相同）
            // 正则表达式，用于捕获所有类型的MathJax定界符
            // 捕获顺序很重要，优先捕获更长的/更明确的定界符
            // 捕获: \(...\), \[...\], $$...$$, 和 $...$
            const mathBlocks = [];
            const mathRegex = /(\\\([\s\S]*?\\\))|(\\\[[\s\S]*?\\\])|(\$\$[\s\S]*?\$\$)|(\$([^\$\n\r]+?)\$)/g;

            // 1. 【隔离】找到所有数学公式，用占位符替换它们
            // 这个过程可以保护公式内部的特殊字符（如 _, *, \\）不被 marked.js 错误解析
            const protectedMarkdown = sourceText.replace(mathRegex, (match) => {
                const placeholder = `<!--MATH_PLACEHOLDER_${mathBlocks.length}-->`;
                mathBlocks.push(match);
                return placeholder;
            });

            // 2. 【解析】使用 Marked.js 解析被保护后的 Markdown 文本
            // 因为所有公式都变成了HTML注释，Marked.js 会安全地忽略它们
            let html = marked.parse(protectedMarkdown);

            // 3. 【还原】将 HTML 中的占位符替换回原始的数学公式字符串
            // 使用正则表达式找到所有占位符并用数组中的公式进行替换
            if (mathBlocks.length > 0) {
                 html = html.replace(/<!--MATH_PLACEHOLDER_(\d+)-->/g, (match, index) => {
                    return mathBlocks[parseInt(index, 10)];
                });
            }

            // 将最终生成的、包含正确公式的 HTML 放入预览区域
            previewDiv.innerHTML = html;

            // 4. 【渲染】最后，让 MathJax 渲染新生成的 HTML 中的数学公式
            if (window.MathJax && window.MathJax.typesetPromise) {
                try {
                    window.MathJax.startup.promise = window.MathJax.startup.promise
                        .then(() => window.MathJax.typesetPromise([previewDiv]))
                        .catch((err) => console.log('MathJax render error:', err));
                } catch (err) {
                    console.log('MathJax render error:', err);
                }
            }
        };

        sourceTextarea.addEventListener('input', updatePreview);
        document.addEventListener('DOMContentLoaded', updatePreview);
        
        // 下载按钮的点击事件 - 无需改动
        downloadBtn.addEventListener('click', async () => {
            downloadBtn.textContent = '正在生成...';
            downloadBtn.disabled = true;

            const sourceText = sourceTextarea.value;

            try {
                const response = await fetch('/download-word-pandoc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sourceText: sourceText })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`服务器错误: ${response.status} - ${errorText}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = '原生公式文档.docx';
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('下载失败:', error);
                alert('下载失败！\n请确保后端服务器已运行，并且已正确安装Pandoc。\n错误详情请查看浏览器控制台。');
            } finally {
                downloadBtn.textContent = '下载为Word文档';
                downloadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
